# A workflow for auto deployment on the test env
name: "CFX TEST auto deploy"

on:
  workflow_dispatch:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+-cfx-[0-9]+-rc.[0-9]+'

jobs:
  # Dispath the remote workflow to update container image tag for test env
  auto-deploy-dispatch:
    name: Dispatch charts repo workflow
    # Perform the deployment only if the tag is received in the input
    if: startsWith(github.ref, 'refs/tags')
    environment: test
    runs-on: ubuntu-latest
    steps:
      # Generate a temporary token using Github app
      - name: Get token
        id: get_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CORE_SERVICES_WORKFLOW_TRIGGER_GH_APP_ID }}
          private-key: ${{ secrets.CORE_SERVICES_WORKFLOW_TRIGGER_GH_APP_PRIVATE_KEY }}
          repositories: core-services-charts
          owner: cofinity-x

      # Trigger remote workflow of core-services-chart to update the image tag in the helm values
      - name: Trigger workflow
        id: trigger_remote_workflow
        env:
          TOKEN: ${{ steps.get_token.outputs.token }}
          HELM_VALUES_PATH: "ssi-credential-issuer/test/values.yaml"
          IMAGE_TAG: ${{ github.ref_name }}
          IMAGE_TAG_PROPERTY: "(.ssi-credential-issuer.[\"service\", \"migrations\", \"credentialExpiry\", \"processesworker\"].image.tag)"
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/cofinity-x/core-services-charts/dispatches \
            -d '{"event_type":"update_dev_image_tag","client_payload": { "image_tag": "'"$IMAGE_TAG"'", "helm_values_path": "'"$HELM_VALUES_PATH"'", "image_tag_property": "'"$IMAGE_TAG_PROPERTY"'", "dispatcher_info": "'"Runner id - $GITHUB_RUN_ID"'" }}' \
            --fail
