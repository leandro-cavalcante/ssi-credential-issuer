# A workflow for Gradle build, Sonar scan, Code QL, Container image build, and image push
name: CFX Build, scan, and push

on:
  workflow_dispatch:
  pull_request:
    types: [ opened, synchronize, reopened ]
    branches: [ main ]
    paths:
      - 'docker/**'
      - 'src/**'
      - 'tests.*'
      - '.github/workflows/cfx-build-scan-push.yaml'
  push:
    branches: [ main ]
    paths:
      - 'docker/**'
      - 'src/**'
      - 'tests.*'
      - '.github/workflows/cfx-build-scan-push.yaml'
    tags:
      - '[0-9]+.[0-9]+.[0-9]+-*'

jobs:
  # 
  build-test-scan-app:
    permissions:
      contents: read
      actions: read
      security-events: write
    name: Build, test, and scan App
    uses: Cofinity-X/central-pipelines/.github/workflows/reusable-dotnet-build.yaml@main
    with:
      dotnet-version: 8.0
      project: "src"
      codeql-cfg-path: .github/codeql/codeql-config.yaml

  # The sonar job needs to use to central resusable worklows once it's available there
  sonar-scan:
    name: Sonar scan
    runs-on: ubuntu-latest
    needs: build-test-scan-app
    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@99b8673ff64fbf99d8d325f52d9a5bdedb8483e9 # v4.2.1
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Cache SonarCloud packages
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        with:
          path: ~/sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache SonarCloud scanner
        id: cache-sonar-scanner
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        with:
          path: ./.sonar/scanner
          key: ${{ runner.os }}-sonar-scanner
          restore-keys: ${{ runner.os }}-sonar-scanner
      - name: Install SonarCloud scanner
        if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
        run: |
          mkdir -p ./.sonar/scanner
          dotnet tool update dotnet-sonarscanner --tool-path ./.sonar/scanner
      - name: Build and analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet tool install --global dotnet-coverage
          ./.sonar/scanner/dotnet-sonarscanner begin /k:Cofinity-X_ssi-credential-issuer /o:cofinity-x /d:sonar.token="${{ secrets.SONAR_TOKEN }}" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.cs.vscoveragexml.reportsPaths=src/coverage.xml
          dotnet build src
          cd src
          dotnet-coverage collect 'dotnet test --no-restore --verbosity normal' -s 'settings-coverage.xml' -f xml -o 'coverage.xml'
          cd ..
          ./.sonar/scanner/dotnet-sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"

  # For Container image build, Trivy scan, and image push
  dockerizing-application:
    needs: build-test-scan-app
    permissions:
      contents: read
      actions: read
      security-events: write
      id-token: write

    strategy:
      matrix:
        include:
          - service_name: ssi-credential-issuer-service
            dockerfile: docker/Dockerfile-credential-issuer-service
          - service_name: ssi-credential-issuer-migrations
            dockerfile: docker/Dockerfile-credential-issuer-migrations
          - service_name: ssi-credential-issuer-processes-worker
            dockerfile: docker/Dockerfile-credential-issuer-processes-worker
          - service_name: ssi-credential-expiry-app
            dockerfile: docker/Dockerfile-credential-expiry-app

    name: Docker build, Trivy scan, Docker push
    uses: Cofinity-X/central-pipelines/.github/workflows/reusable-publish-image-to-acr.yaml@main
    with:
      team_name: core-services
      repository_name: ssi-issuer
      service_name: ${{ matrix.service_name }}
      dockerfile_path: ${{ matrix.dockerfile }}
      environment: "lower-env-acr"
      push: ${{ github.event_name != 'pull_request' }} # Don't push the image in case of PR
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
